<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>EMTF</title>
</head>
<body>
    <main class="flex">
        <h1>Welcome to EMTF</h1>
        <form id='signup-form' action="">
            <label for="username">Username</label>
            <input type="text" name="username" id="username" placeholder="Enter a username">
            <label for="email">Email</label>
            <input type="email" name="email" id="email" placeholder="Enter your email" required>
            <label for="password">Password</label>
            <input type="password" name="password" id="password" placeholder="Enter your password" required>
            <button type="submit" class="sign-up mb-1" id="goToLoginPage">Sign Up</button>
            <span>
                <p class="mr-1">Already have an account?</p>
                <a href="/login.html">Login</a>
            </span>
        </form>
    </main>

    <!-- connecting to the supabase backend -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- js file to handle interaction on the website -->
    <script type="module">
        console.log('testing...');

        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        const supabase = createClient('https://usfjmohkctzxjizmledb.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzZmptb2hrY3R6eGppem1sZWRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTEyNjQ3MDgsImV4cCI6MjAwNjg0MDcwOH0.Leblc7VH2rYfJTQKwFc3s6mON8-PbNLNzJrZvh94Tlg')

        console.log(supabase);
        
        const loginForm = document.querySelector('#login-form');
        const signupForm = document.querySelector('#signup-form');
        const searchForm = document.querySelector('#search-form');
        const searchResultsSection = document.querySelector('#search-container');
        const header = document.querySelector('h1');

        signupForm.addEventListener('submit', async function (event) {
            event.preventDefault(); // Prevent the default form submission

            const signupFormData = new FormData(signupForm);
            const username = signupFormData.get('username');
            const email = signupFormData.get('email');
            const password = signupFormData.get('password');

            // Validate the form data (if needed)
            if (!email || !password) {
                alert('Please fill in all the fields.');
                return;
            }

            // Use Supabase's auth.signUp() method
            let {data, error} = await supabase.auth.signUp({ username, email, password })
                .then(response => {
                    console.log('Sign-up successful:', response);
                    // Optionally, you can redirect the user to a login page after successful sign-up.
                })
                .catch(error => {
                    console.error('Sign-up error:', error);
                }); 

                console.log('Sign-up data:', data);
                alert('Please check your email for a verification link.')

                document.getElementById('goToLoginPage').addEventListener('click', function () {
                    window.location.href = 'login.html'; // Change 'login.html' to your actual login page URL
                });
        });

        loginForm.addEventListener('submit', async function (event) {
            event.preventDefault(); // Prevent the default form submission

            const loginFormData = new FormData(loginForm);
            const email = signupFormData.get('email');
            const password = signupFormData.get('password');

            if (!email || !password) {
                alert('Please fill in all the fields.');
                return;
            }
            
            // Use Supabase's auth.signIn() method
            let {data, error} = await supabase.auth.signInWithPassword({ email, password })
                .then(response => {
                    console.log('Login successful:', response);
                    // Optionally, you can redirect the user to a dashboard or protected page after successful login.
                })
                .catch(error => {
                    console.error('Login error:', error);
                });   
                
                console.log('Login data:', data);
        });

        searchForm.addEventListener('submit', async function (event) {
            event.preventDefault(); // Prevent the default form submission
            
            const search = searchFormData.get('search');
            const searchFormData = new FormData(searchForm);
            const searchTerm = search.valueOf();    
            
            if (!search) {
                alert('Please enter a school.');
                return;
            }

            console.log(searchTerm);
            
            // Use Supabase's auth.signIn() method
            let {data, error} = await supabase
                .from('List of schools')
                .select()
                .then(response => {
                    console.log('Search successful:', response);
                    // Optionally, you can redirect the user to a dashboard or protected page after successful login.
                })
                .catch(error => {
                    console.error('Search error:', error);
                });   

            console.log('These are the schools: ', data);

            header.innerHTML = ``;

            // Display new search results
            if (data && data.length > 0) {
                data.forEach(item => {
                    const resultElement = document.createElement('div');
                    resultElement.innerHTML = 
                        `
                            <div>
                                <h2>${item.school_name}</h2>
                                <h3>${item.location}</h3>
                                <p>${item.description}</p>
                            </div> 
                        `;

                    //   resultElement.textContent = item.column_name; // Display the relevant column data
                    searchResultsSection.appendChild(resultElement);
                });
            } else {
                const noResultsElement = document.createElement('div');
                noResultsElement.textContent = 'No results found.';
                searchResultsSection.appendChild(noResultsElement);
            }
        });
    </script>
</body>
</html>